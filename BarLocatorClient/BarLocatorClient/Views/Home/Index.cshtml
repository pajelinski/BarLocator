@{
    ViewBag.Title = "Home Page";
}

<script src="http://maps.google.com/maps/api/js?key=AIzaSyBUVzdLCvCVhgCnU7YO2mb1bHA_N9r0ugc&sensor=true" type="text/javascript"></script>

<div id="map_canvas" style="height: 550px;"></div>
<br/>
<input type="button" value="Find bars around Main Square in Krakow" onclick="MarkNearbyBars()" />

@section scripts {
    <section class="scripts">
        <script type="text/javascript">
            $(document).ready(function () {
                initialize();
            });

            var map;

            function MarkNearbyBars() {
                $.ajax({
                    url: '@Url.Action("GetNearbyBarLocations", "Home")',
                    type: 'GET',
                    dataType: 'json',
                    cache: false,
                    success: SetBarMarkers
                });
            }

            function SetBarMarkers(data) {
                var parsedData = JSON.parse(data);
                for (var i = 0; i < parsedData.results.length; i++) {
                    var result = parsedData.results[i];
                    var position = result.geometry.location;
                    setMarker(map, position, result.name);
                }
                map.setCenter({ lat: 50.0618971, lng: 19.9345673 });
            }

            function initialize() {

                google.maps.visualRefresh = true;

                var mapOptions = {
                    zoom: 8,
                    center: { lat: -34.397, lng: 150.644 },
                    mapTypeId: google.maps.MapTypeId.G_NORMAL_MAP
                };

                var infoWindow = new google.maps.InfoWindow({ map: map });

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function (position) { markCurrentPosition(map, position) },
                        function () {window.handleLocationError(true, infoWindow, map.getCenter());
                    });
                } else {
                    window.handleLocationError(false, infoWindow, map.getCenter());
                }

                map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
            }

            function markCurrentPosition(map, position) {
                var pos = mapLocaliztion(position);

                setBlueMarker(map, pos, "Your location");
                map.setCenter(pos);
            }

            function setBlueMarker(map, position, title) {
                var marker = setMarker(map, position, title);
                marker.setIcon('http://maps.google.com/mapfiles/ms/icons/blue-dot.png');
            }

            function setMarker(map, position, title) {
                return new google.maps.Marker({
                    'position': position,
                    'map': map,
                    'title': title
                });
            }

            function mapLocaliztion(position) {
                return {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
            }

        </script>
    </section>
}